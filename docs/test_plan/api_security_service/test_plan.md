[**[Return To All Test Plans]**]

- [Test Plan for CAPIF Api Security Service](#test-plan-for-capif-api-security-service)
- [Tests](#tests)
  - [Test Case 1: Create a security context for an API invoker](#test-case-1-create-a-security-context-for-an-api-invoker)
  - [Test Case 2: Create a security context for an API invoker with Exposer role](#test-case-2-create-a-security-context-for-an-api-invoker-with-exposer-role)
  - [Test Case 3: Create a security context for an API invoker with Exposer entity role and invalid apiInvokerId](#test-case-3-create-a-security-context-for-an-api-invoker-with-exposer-entity-role-and-invalid-apiinvokerid)
  - [Test Case 4: Create a security context for an API invoker with Invoker entity role and invalid apiInvokerId](#test-case-4-create-a-security-context-for-an-api-invoker-with-invoker-entity-role-and-invalid-apiinvokerid)
  - [Test Case 5: Retrieve the Security Context of an API Invoker](#test-case-5-retrieve-the-security-context-of-an-api-invoker)
  - [Test Case 6: Retrieve the Security Context of an API Invoker with invalid apiInvokerID](#test-case-6-retrieve-the-security-context-of-an-api-invoker-with-invalid-apiinvokerid)
  - [Test Case 7: Retrieve the Security Context of an API Invoker with invalid apfId](#test-case-7-retrieve-the-security-context-of-an-api-invoker-with-invalid-apfid)
  - [Test Case 8: Delete the Security Context of an API Invoker](#test-case-8-delete-the-security-context-of-an-api-invoker)
  - [Test Case 9: Delete the Security Context of an API Invoker with Invoker entity role](#test-case-9-delete-the-security-context-of-an-api-invoker-with-invoker-entity-role)
  - [Test Case 10: Delete the Security Context of an API Invoker with Invoker entity role and invalid apiInvokerID](#test-case-10-delete-the-security-context-of-an-api-invoker-with-invoker-entity-role-and-invalid-apiinvokerid)
  - [Test Case 11: Delete the Security Context of an API Invoker with invalid apiInvokerID](#test-case-11-delete-the-security-context-of-an-api-invoker-with-invalid-apiinvokerid)
  - [Test Case 12: Update the Security Context of an API Invoker](#test-case-12-update-the-security-context-of-an-api-invoker)
  - [Test Case 13: Update the Security Context of an API Invoker with Exposer entity role](#test-case-13-update-the-security-context-of-an-api-invoker-with-exposer-entity-role)
  - [Test Case 14: Update the Security Context of an API Invoker with AEF entity role and invalid apiInvokerId](#test-case-14-update-the-security-context-of-an-api-invoker-with-aef-entity-role-and-invalid-apiinvokerid)
  - [Test Case 15: Update the Security Context of an API Invoker with invalid apiInvokerID](#test-case-15-update-the-security-context-of-an-api-invoker-with-invalid-apiinvokerid)
  - [Test Case 16: Revoke the authorization of the API invoker for APIs.](#test-case-16-revoke-the-authorization-of-the-api-invoker-for-apis)
  - [Test Case 17: Revoke the authorization of the API invoker for APIs without valid apfID.](#test-case-17-revoke-the-authorization-of-the-api-invoker-for-apis-without-valid-apfid)
  - [Test Case 18: Revoke the authorization of the API invoker for APIs with invalid apiInvokerId.](#test-case-18-revoke-the-authorization-of-the-api-invoker-for-apis-with-invalid-apiinvokerid)
  - [Test Case 19: Retrieve access token](#test-case-19-retrieve-access-token)
  - [Test Case 20: Retrieve access token by AEF](#test-case-20-retrieve-access-token-by-aef)
  - [Test Case 21: Retrieve access token by AEF with invalid apiInvokerId](#test-case-21-retrieve-access-token-by-aef-with-invalid-apiinvokerid)
  - [Test Case 22: Retrieve access token with invalid apiInvokerId](#test-case-22-retrieve-access-token-with-invalid-apiinvokerid)
 


# Test Plan for CAPIF Api Security Service
At this documentation you will have all information and related files and examples of test plan for this API.

# Tests

## Test Case 1: Create a security context for an API invoker
* Test ID: ***capif_security_api-1***
* Description:
  
  This test case will check that an API Invoker can create a Security context
* Pre-Conditions:
  
  * API Invoker is pre-authorised (has valid apiInvokerID from CAPIF Authority)

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create Security Context for this Invoker
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * body [service security body]

* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Store signed Certificate
  3. Create Security Context
   
* Expected Result:

  1. Create security context:
     1. **201 Created** response.
     2. body returned must accomplish **ServiceSecurity** data structure.
     3. Location Header must contain the new resource URL *{apiRoot}/capif-security/v1/trustedInvokers/{apiInvokerId}*


## Test Case 2: Create a security context for an API invoker with Exposer role
* Test ID: ***capif_security_api-2***
* Description:
  
  This test case will check that an Exposer cannot create a Security context with valid apiInvokerId.
* Pre-Conditions:
  
  * API Invoker is pre-authorised (has valid apiInvokerID), but user that create Security Context with Exposer role

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create public and private key at publisher

  5. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId

  6. Create Security Context for this Invoker but using Exposer certificate.
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * body [service security body]
     * Using Exposer certificate

* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Register Exposer at CCF
  3. Create Security Context using Exposer certificate
   
* Expected Result:

  1. Create security context using Exposer certificate:
     1. **403 Forbiddent** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 403
        * title with message "Forbidden"
        * detail with message "Role not authorized for this API route".
        * cause with message "User role must be invoker".

  2. No context stored at DB

## Test Case 3: Create a security context for an API invoker with Exposer entity role and invalid apiInvokerId
* Test ID: ***capif_security_api-3***
* Description:

  This test case will check that an Exposer cannot create a Security context with invalid apiInvokerID.
* Pre-Conditions:
  
  * API Invoker is pre-authorised (has valid apiInvokerID), but user that create Security Context with Exposer role

* Information of Test:

  1. Create public and private key at publisher

  2. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId

  3. Create Security Context for this not valid apiInvokerId and using Exposer certificate.
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{API_INVOKER_NOT_VALID}*
     * body [service security body]
     * Using Exposer certificate

* Execution Steps:
  
  1. Register Exposer at CCF
  2. Create Security Context using Exposer certificate
   
* Expected Result:

  1. Create security context using Exposer certificate:
     1. **403 Forbiddent** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 403
        * title with message "Forbidden"
        * detail with message "Role not authorized for this API route".
        * cause with message "User role must be invoker".
  2. No context stored at DB

## Test Case 4: Create a security context for an API invoker with Invoker entity role and invalid apiInvokerId
* Test ID: ***capif_security_api-4***
* Description:
  
  This test case will check that an Invoker cannot create a Security context with valid apiInvokerId.
* Pre-Conditions:
  
  * API Invoker is pre-authorised (has valid apiInvokerID), but user that create Security Context with invalid apiInvokerId

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create Security Context for this Invoker:
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{API_INVOKER_NOT_VALID}*
     * body [service security body]

* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Create Security Context using Exposer certificate
   
* Expected Result:

  1. Create security context using Exposer certificate:
     1. **404 Not Found** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 404
        * title with message "Not Found"
        * detail with message "Invoker not found".
        * cause with message "API Invoker not exists or invalid ID".

  2. No context stored at DB

  
## Test Case 5: Retrieve the Security Context of an API Invoker
* Test ID: ***capif_security_api-5***
* Description:
  
  This test case will check that an exposer can retrieve the Security context of an API Invoker
* Pre-Conditions:
  
  * Exposer is pre-authorised (has valid apfId from CAPIF Authority) and API Invoker has created a valid Security Context

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create Security Context for this Invoker but using Exposer certificate.
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * body [service security body]
     * Using Exposer certificate

  5. Create public and private key at publisher

  6. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId

  7. Retrieve Security Context of Invoker by Exposer:
     * Send GET *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*

* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Register Exposer at CCF
  3. Create Security Context using Exposer certificate
  4. Retrieve Security Context by exposer
   
* Expected Result:
  1. Retrieve security context:
     1. **200 OK** response.
     2. body returned must accomplish **ServiceSecurity** data structure.


## Test Case 6: Retrieve the Security Context of an API Invoker with invalid apiInvokerID
* Test ID: ***capif_security_api-6***
* Description:
  
  This test case will check that an exposer can retrieve the Security context of an API Invoker
* Pre-Conditions:
  
  * Exposer is pre-authorised (has valid apfId from CAPIF Authority) and API Invoker has created a valid Security Context

* Information of Test:

  1. Create public and private key at publisher

  2. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId

  3. Retrieve Security Context of invalid Invoker by Exposer:
     * Send GET *https://{CAPIF_HOSTNAME}/trustedInvokers/{API_INVOKER_NOT_VALID}*

* Execution Steps:
  
  2. Register Exposer at CCF
  3. Create Security Context using Exposer certificate
  4. Retrieve Security Context by exposer of invalid invoker
   
* Expected Result:
  1. Retrieve security context:
     1. **404 Not Found** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 404
        * title with message "Not Found"
        * detail with message "Invoker not found".
        * cause with message "API Invoker not exists or invalid ID".


## Test Case 7: Retrieve the Security Context of an API Invoker with invalid apfId
* Test ID: ***capif_security_api-7***
* Description:
  
  This test case will check that an Exposer cannot retrieve the Security context of an API Invoker without valid apfId
* Pre-Conditions:
  
  * API Exposure Function is not pre-authorised (has invalid apfId)

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create Security Context for this Invoker
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * body [service security body]

  5. Retrieve Security Context as Invoker role:
     1. Send GET *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*

* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Store signed Certificate
  3. Create Security Context
  4. Retrieve Security Context as Exposer.
   
* Expected Result:

  1. Create security context:
     1. **403 Forbidden** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 403
        * title with message "Forbidden"
        * detail with message "Role not authorized for this API route".
        * cause with message "User role must be exposer".


## Test Case 8: Delete the Security Context of an API Invoker
* Test ID: ***capif_security_api-8***
* Description:
  
  This test case will check that an Exposer can delete a Security context
* Pre-Conditions:
  
  * Exposer is pre-authorised (has valid apfId from CAPIF Authority) and API Invoker has created a valid Security Context

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create Security Context for this Invoker but using Exposer certificate.
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * body [service security body]
     * Using Exposer certificate

  5. Create public and private key at publisher

  6. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId

  7. Delete Security Context of Invoker by Exposer:
     * Send DELETE *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * Use exposer certificate

  8. Retrieve Security Context of Invoker by Exposer:
     * Send GET *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*

* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Register Exposer at CCF
  3. Create Security Context using Exposer certificate
  4. Delete Security Context by exposer
   
* Expected Result:

  1. Delete security context:
     1. **204 No Content** response.

  2. Retrieve security context:
     1. **404 Not Found** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 404
        * title with message "Not Found"
        * detail with message "Invoker not found".
        * cause with message "API Invoker not exists or invalid ID".


## Test Case 9: Delete the Security Context of an API Invoker with Invoker entity role
* Test ID: ***capif_security_api-9***
* Description:
  
  This test case will check that an Invoker cannot delete a Security context
* Pre-Conditions:
  
  * Exposer is pre-authorised (has valid apfId from CAPIF Authority) and API Invoker has created a valid Security Context

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create Security Context for this Invoker but using Exposer certificate.
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * body [service security body]
     * Using Exposer certificate

  7. Delete Security Context of Invoker by Exposer:
     * Send DELETE *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * Use invoker certificate

* Execution Steps:
  
  1. Register Exposer at CCF
  2. Create Security Context using Exposer certificate
  3. Delete Security Context by invoker
   
* Expected Result:

  1. Delete security context:
     1. **403 Forbidden** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 403
        * title with message "Forbidden"
        * detail with message "Role not authorized for this API route".
        * cause with message "User role must be exposer".


## Test Case 10: Delete the Security Context of an API Invoker with Invoker entity role and invalid apiInvokerID
* Test ID: ***capif_security_api-10***
* Description:
  
  This test case will check that an Invoker cannot delete a Security context with invalid 
* Pre-Conditions:
  
  * Invoker is pre-authorised.

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Delete Security Context of Invoker by Exposer:
     * Send DELETE *https://{CAPIF_HOSTNAME}/trustedInvokers/{API_INVOKER_NOT_VALID}*
     * Use invoker certificate

* Execution Steps:
  
  1. Register Exposer at CCF
  3. Delete Security Context by invoker
   
* Expected Result:

  1. Delete security context:
     1. **403 Forbidden** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 403
        * title with message "Forbidden"
        * detail with message "Role not authorized for this API route".
        * cause with message "User role must be exposer".


## Test Case 11: Delete the Security Context of an API Invoker with invalid apiInvokerID
* Test ID: ***capif_security_api-11***
* Description:
  
  This test case will check that an Exposer cannot delete a Security context of invalid apiInvokerId
* Pre-Conditions:
  
  * Exposer is pre-authorised (has valid apfId from CAPIF Authority).

* Information of Test:

  1. Create public and private key at publisher

  2. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId

  3. Delete Security Context of Invoker by Exposer:
     * Send DELETE *https://{CAPIF_HOSTNAME}/trustedInvokers/{API_INVOKER_NOT_VALID}*
     * Use exposer certificate

* Execution Steps:
  
  1. Register Exposer at CCF
  2. Delete Security Context by exposer
   
* Expected Result:

  1. Retrieve security context:
     1. **404 Not Found** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 404
        * title with message "Not Found"
        * detail with message "Invoker not found".
        * cause with message "API Invoker not exists or invalid ID".


## Test Case 12: Update the Security Context of an API Invoker 
* Test ID: ***capif_security_api-12***
* Description:
  
  This test case will check that an API Invoker can update a Security context
* Pre-Conditions:
  
  * API Invoker is pre-authorised (has valid apiInvokerID from CAPIF Authority) and Exposer is also authorized

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create public and private key at publisher
  
  5. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId

  6. Create Security Context for this Invoker:
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * body [service security body]
 
  7. Update Security Context of Invoker:
     * Send POST *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}/update*
     * body [service security body] but with notification destination modified to http://robot.testing2

  8. Retrieve Security Context of Invoker by Exposer:
     * Send GET *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*

* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Register Exposer at CCF
  3. Create Security Context
  4. Update Security Context
  5. Retrieve Security Context
   
* Expected Result:

  1. Update security context:
     1. **200 OK** response.
     2. body returned must accomplish **ServiceSecurity** data structure.
 
  2. Retrieve security context:
     1. **200 OK** response.
     2. body returned must accomplish **ServiceSecurity** data structure.
        1. Check is this returned object match with modified one.


## Test Case 13: Update the Security Context of an API Invoker with Exposer entity role
* Test ID: ***capif_security_api-13***
* Description:
  
  This test case will check that an Exposer cannot update a Security context

* Pre-Conditions:
  
  * API Invoker is pre-authorised (has valid apiInvokerID from CAPIF Authority) and Exposer is also authorized.
  * Invoker has created the Security Context previously.

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create public and private key at publisher
  
  5. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId

  6. Create Security Context for this Invoker:
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * body [service security body]
 
  7. Update Security Context of Invoker:
     * Send POST *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}/update*
     * body [service security body] but with notification destination modified to http://robot.testing2
     * Using Exposer Certificate

* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Register Exposer at CCF
  3. Create Security Context
  4. Update Security Context as Exposer
   
* Expected Result:

  1. Update security context:
     1. **403 Forbidden** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 403
        * title with message "Forbidden"
        * detail with message "Role not authorized for this API route".
        * cause with message "User role must be invoker". 


## Test Case 14: Update the Security Context of an API Invoker with AEF entity role and invalid apiInvokerId
* Test ID: ***capif_security_api-14***
* Description:
  
  This test case will check that an Exposer cannot update a Security context of invalid apiInvokerId

* Pre-Conditions:
  
  * API Invoker is pre-authorised (has valid apiInvokerID from CAPIF Authority) and Exposer is also authorized.
  * Invoker has created the Security Context previously.

* Information of Test:

  1. Create public and private key at publisher
  
  2. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId
 
  3. Update Security Context of Invoker:
     * Send POST *https://{CAPIF_HOSTNAME}/trustedInvokers/{API_INVOKER_NOT_VALID}/update*
     * body [service security body]
     * Using Exposer Certificate

* Execution Steps:
  
  1. Register Exposer at CCF
  2. Update Security Context as Exposer
   
* Expected Result:

  1. Update security context:
     1. **403 Forbidden** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 403
        * title with message "Forbidden"
        * detail with message "Role not authorized for this API route".
        * cause with message "User role must be invoker". 


## Test Case 15: Update the Security Context of an API Invoker with invalid apiInvokerID
* Test ID: ***capif_security_api-15***
* Description:
  
  This test case will check that an API Invoker cannot update a Security context not valid apiInvokerId
* Pre-Conditions:
  
  * API Invoker is pre-authorised (has valid apiInvokerID from CAPIF Authority)

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.
 
  4. Update Security Context of Invoker:
     * Send POST *https://{CAPIF_HOSTNAME}/trustedInvokers/{API_INVOKER_NOT_VALID}/update*
     * body [service security body] but with notification destination modified to http://robot.testing2

* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Update Security Context
   
* Expected Result:

1. Retrieve security context:
     1. **404 Not Found** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 404
        * title with message "Not Found"
        * detail with message "Invoker not found".
        * cause with message "API Invoker not exists or invalid ID".


## Test Case 16: Revoke the authorization of the API invoker for APIs.
* Test ID: ***capif_security_api-16***
* Description:
  
  This test case will check that an Exposer can revoke the authorization for APIs

* Pre-Conditions:
  
  * API Invoker is pre-authorised (has valid apiInvokerID from CAPIF Authority) and Exposer is also authorized

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create public and private key at publisher
  
  5. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId

  6. Create Security Context for this Invoker:
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * body [service security body]
 
  7. Revoke Authorization:
     * Send POST *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}/delete*
     * body [security notification body]

  8. Retrieve Security Context of Invoker by Exposer:
     * Send GET *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*


* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Register Exposer at CCF
  3. Create Security Context
  4. Revoke Security Context by exposer
  5. Retrieve Security Context
   
* Expected Result:

  1. Revoke Authorization:
     1. **204 No Content** response.

  2. Retrieve security context:
     1. **404 Not Found** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 404
        * title with message "Not Found"
        * detail with message "Invoker not found".
        * cause with message "API Invoker not exists or invalid ID".


## Test Case 17: Revoke the authorization of the API invoker for APIs without valid apfID.
* Test ID: ***capif_security_api-17***
* Description:
  
  This test case will check that an Invoker can't revoke the authorization for APIs

* Pre-Conditions:
  
  * API Invoker is pre-authorised (has valid apiInvokerID from CAPIF Authority) and Exposer is also authorized

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create public and private key at publisher
  
  5. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId

  6. Create Security Context for this Invoker:
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * body [service security body]
 
  7. Revoke Authorization by invoker:
     * Send POST *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}/delete*
     * body [security notification body]
     * using invoker certificate

  8. Retrieve Security Context of Invoker by Exposer:
     * Send GET *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*


* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Register Exposer at CCF
  3. Create Security Context
  4. Revoke Security Context by invoker
  5. Retrieve Security Context
   
* Expected Result:

  1. Revoke Security Context by invoker:
     1. **403 Forbidden** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 403
        * title with message "Forbidden"
        * detail with message "Role not authorized for this API route".
        * cause with message "User role must be exposer". 

  3. Retrieve security context:
     1. **200 OK** response.
     2. body returned must accomplish **ServiceSecurity** data structure.
        1. Check is this returned object match with created one.


## Test Case 18: Revoke the authorization of the API invoker for APIs with invalid apiInvokerId.
* Test ID: ***capif_security_api-18***
* Description:
  
  This test case will check that an API Exposure Function cannot revoke the authorization for APIs for invalid apiInvokerId

* Pre-Conditions:
  
  * API Invoker is pre-authorised (has valid apiInvokerID from CAPIF Authority) and Exposer is also authorized

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [invoker register body]

  3. Onboard Invoker:
     * Send POST to *https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers*
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Create public and private key at publisher
  
  5. Register of Exposer at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId

  6. Create Security Context for this Invoker:
     * Send PUT *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*
     * body [service security body]
 
  7. Revoke Authorization by exposer:
     * Send POST *https://{CAPIF_HOSTNAME}/trustedInvokers/{API_INVOKER_NOT_VALID}/delete*
     * body [security notification body]

  8. Retrieve Security Context of Invoker by Exposer:
     * Send GET *https://{CAPIF_HOSTNAME}/trustedInvokers/{apiInvokerId}*


* Execution Steps:
  
  1. Register and onboard Invoker at CCF
  2. Register Exposer at CCF
  3. Create Security Context
  4. Revoke Security Context by exposer
  5. Retrieve Security Context
   
* Expected Result:

  1. Revoke Security Context by invoker:
     1. **404 Not Found** response.
     2. body returned must accomplish **ProblemDetails** data structure, with:
        * status 404
        * title with message "Not Found"
        * detail with message "Invoker not found".
        * cause with message "API Invoker not exists or invalid ID".

  3. Retrieve security context:
     1. **200 OK** response.
     2. body returned must accomplish **ServiceSecurity** data structure.
        1. Check is this return one object that match with created one.






-------
  
  This test case will check that an API Exposure Function cannot revoke the authorization for APIs for invalid apiInvokerId

* Pre-Conditions: 
  
  API Exposure Function is  pre-authorised (has valid apfID) but apiIvokerId has no Security Context

* Actions:

  POST  /trustedInvokers/{apiInvokerId}/delete: 
    
  Request Body: [security notification body]

* Post-Conditions:
  
  Security Context for API Invoker to access APIs of APIE Exposure Function is not deleted in CAPIF Database

  404 Not Found

## Test Case 19: Retrieve access token
  
  This test case will check that an API Invoker can retrieve a security access token 

* Pre-Conditions: 
  
  API Invoker is pre-authorised (has valid apiInvokerId)

* Actions:

  POST /securities/{securityId}/token: //securityId will be the apiInvokerId
    
  Request Body: [access token req body]

* Post-Conditions:
  
  OAuth 2.0 access token is provided to API Invoker

  200 Successful Access Token Request

## Test Case 20: Retrieve access token by AEF
  
  This test case will check that an API Exposure Function cannot retrieve a security access token

* Pre-Conditions: 
  
  API Invoker is not pre-authorised (has invalid apiInvokerId)

* Actions:

  POST /securities/{securityId}/token: //securityId will be the apiInvokerId
    
  Request Body: [access token req body]

* Post-Conditions:
  
  OAuth 2.0 access token is not provided to API Invoker

  400 with next body:

  400 BAD REQUEST with next body:

```
{
  "error": "invalid_client", 
  "error_description": "Role not authorized for this API route"
} 
```
  ## Test Case 21: Retrieve access token by AEF with invalid apiInvokerId

  is test case will check that an API Exposure Function cannot retrieve a security access token without valid apiInvokerId

* Pre-Conditions:

  API Invoker is not pre-authorised (has invalid apiInvokerId)

* Actions:

  POST /securities/{securityId}/token: //securityId will be the apiInvokerId

  Request Body: [access token req body]

* Post-Conditions:

  OAuth 2.0 access token is not provided to API Invoker


  400 BAD REQUEST with next body:

```
{
  "error": "invalid_client", 
  "error_description": "Role not authorized for this API route"
} 
```

## Test Case 22: Retrieve access token with invalid apiInvokerId

  This test case will check that an API Invoker can't retrieve a security access token without valid apiInvokerId

* Pre-Conditions:

  API Invoker is pre-authorised (has valid apiInvokerId)

* Actions:

  POST /securities/{securityId}/token: //securityId will be the apiInvokerId

  Request Body: [access token req body]

* Post-Conditions:

  OAuth 2.0 access token is provided to API Invoker

  400 BAD REQUEST with next body:

```
{
  "error": "invalid_request", 
  "error_description": "No Security Context for this API Invoker"} 
} 
```

  [Return To All Test Plans]: ../README.md



  [service security body]: ./service_security.json  "Service Security Request"
  [security notification body]: ./security_notification.json  "Security Notification Request"
  [access token req body]: ./access_token_req.json  "Access Token Request"
  [invoker onboarding body]: ../api_invoker_management/invoker_details_post_example.json  "API Invoker Request"
  [invoker register body]: ../api_invoker_management/invoker_register_body.json  "Invoker Register Body"

