[**[Return To All Test Plans]**]

- [Test Plan for CAPIF Api Events Service](#test-plan-for-capif-api-events-service)
- [Tests](#tests)
  - [Test Case 1: Creates a new individual CAPIF Event Subscription.](#test-case-1-creates-a-new-individual-capif-event-subscription)
  - [Test Case 2: Creates a new individual CAPIF Event Subscription with Invalid SubscriberId](#test-case-2-creates-a-new-individual-capif-event-subscription-with-invalid-subscriberid)
  - [Test Case 3: Deletes an individual CAPIF Event Subscription](#test-case-3-deletes-an-individual-capif-event-subscription)
  - [Test Case 4: Deletes an individual CAPIF Event Subscription with invalid SubscriberId](#test-case-4-deletes-an-individual-capif-event-subscription-with-invalid-subscriberid)
  - [Test Case 5: Deletes an individual CAPIF Event Subscription with invalid SubscriptionId](#test-case-5-deletes-an-individual-capif-event-subscription-with-invalid-subscriptionid)
 


# Test Plan for CAPIF Api Events Service
At this documentation you will have all information and related files and examples of test plan for this API.

# Tests

## Test Case 1: Creates a new individual CAPIF Event Subscription.
* Test ID: ***capif_api_events-1***
* Description:

  This test case will check that a CAPIF subscriber (Invoker or Publisher) can Subscribe to Events
* Pre-Conditions:
  
  * CAPIF subscriber is pre-authorised (has valid InvokerId or apfId from CAPIF Authority)

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register 
     * body [invoker register body]
     * Get subscriberId

  3. Onboard Invoker:
     * Send POST to https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers
     * Reference Request Body: [invoker onboard request body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Event Subscription:
     1. Send POST to https://{CAPIF_HOSTNAME}/capif-events/v1/{subscriberId}/subscriptions
     2. body [event subscription request body]

* Execution Steps:
  
  1. Register And Onboard Invoker at CCF
  2. Store signed Certificate
  3. Subscribe to Events
  4. Retrieve {subscriberId} and {subscriptionId} from Location Header
   
* Expected Result:

  1. Response to Onboard request must accomplish:
     1. **201 Created**
     2. Response Body must follow **APIInvokerEnrolmentDetails** data structure with:
        * apiInvokerId
        * onboardingInformation->apiInvokerCertificate must contain the public key signed.
     3. Response Header **Location** must be received with URI to new resource created, following this structure: *{apiRoot}/api-invoker-management/{apiVersion}/onboardedInvokers/{onboardingId}*

  2. Response to Event Subscription must accomplish:
     1. 201 Created
     2. The URI of the created resource shall be returned in the "Location" HTTP header, following this structure: *{apiRoot}/capif-events/{apiVersion}/{subscriberId}/subscriptions/{subscriptionId}
     3. Response Body must follow **EventSubscription** data structure.

  3. Event Subscriptions are stored in CAPIF Database


## Test Case 2: Creates a new individual CAPIF Event Subscription with Invalid SubscriberId
* Test ID: ***capif_api_events-2***
* Description:

  This test case will check that a CAPIF subscriber (Invoker or Publisher) cannot Subscribe to Events without valid SubcriberId
* Pre-Conditions:
  
  * CAPIF subscriber is not pre-authorised (has invalid InvokerId or apfId)

* Information of Test:

  1. Create public and private key at invoker

  2. Register of Invoker at CCF:
     * Send POST to http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register 
     * body [invoker register body]
     * Get subscriberId

  3. Onboard Invoker:
     * Send POST to https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers
     * Reference Request Body: [invoker onboard request body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  4. Event Subscription:
     1. Send POST to https://{CAPIF_HOSTNAME}/capif-events/v1/{SUBSCRIBER_NOT_REGISTERED}/subscriptions
     2. body [event subscription request body]

* Execution Steps:
  
  1. Register And Onboard Invoker at CCF
  2. Store signed Certificate
  3. Subscribe to Events
  4. Retrieve {subscriberId} and {subscriptionId} from Location Header
   
* Expected Result:

  1. Response to Onboard request must accomplish:
     1. **201 Created**
     2. Response Body must follow **APIInvokerEnrolmentDetails** data structure with:
        * apiInvokerId
        * onboardingInformation->apiInvokerCertificate must contain the public key signed.
     3. Response Header **Location** must be received with URI to new resource created, following this structure: *{apiRoot}/api-invoker-management/{apiVersion}/onboardedInvokers/{onboardingId}*

  2. Response to Event Subscription must accomplish:
     1. **403 Forbidden**
     2. Error Response Body must accomplish with **ProblemDetails** data structure with:
        * detail with message "Event API not existing".
        * cause with message "Event Subscriptions are not stored in CAPIF Database".

  3. Event Subscriptions are not stored in CAPIF Database

  
## Test Case 3: Deletes an individual CAPIF Event Subscription
  
  This test case will check that a CAPIF subscriber (Invoker or Publisher) can Delete an Event Subscription

* Pre-Conditions: 
  
  CAPIF subscriber is pre-authorised (has valid InvokerId or apfId) and one previsouly subscription is present.

* Actions:

  DELETE Event Subscription

* Post-Conditions:
  
  Event Subscription with SubscriptionId is deleted from CAPIF Database

  204 The individual CAPIF Events Subscription matching the subscriptionId is deleted.

## Test Case 4: Deletes an individual CAPIF Event Subscription with invalid SubscriberId
  
  This test case will check that a CAPIF subscriber (Invoker or Publisher) cannot Delete an Event Subscription without valid SubscriberId

* Pre-Conditions: 
  
  CAPIF subscriber is not pre-authorised (has invalid InvokerId or apfId) 

* Actions:

  DELETE Event Subscription

* Post-Conditions:
  
  Event Subscription with SubscriptionId is not deleted from CAPIF Database

  403 Forbidden

## Test Case 5: Deletes an individual CAPIF Event Subscription with invalid SubscriptionId
  
  This test case will check that a CAPIF subscriber (Invoker or Publisher) cannot Delete an Event Subscription without valid SubscriptionId

* Pre-Conditions: 
  
  CAPIF subscriber is pre-authorised (has valid InvokerId or apfId) but Event to delete has invalid SubscriptionId
  
* Actions:

  DELETE Event Subscription

* Post-Conditions:
  
  404 Not Found

[invoker register body]: ../api_invoker_management/invoker_register_body.json  "Invoker Register Body"
[invoker onboard request body]: ../api_invoker_management/invoker_details_post_example.json  "API Invoker Request"
[event subscription request body]: ./event_subscription.json  "Event Subscription Request"


[Return To All Test Plans]: ../README.md
