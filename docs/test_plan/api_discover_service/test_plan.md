[**[Return To All Test Plans]**]

- [Test Plan for CAPIF Discover Service](#test-plan-for-capif-discover-service)
- [Tests](#tests)
  - [Test Case 1: Discover Published service APIs by Authorised API Invoker](#test-case-1-discover-published-service-apis-by-authorised-api-invoker)
  - [Test Case 2: Discover Published service APIs by Non Authorised API Invoker](#test-case-2-discover-published-service-apis-by-non-authorised-api-invoker)
  - [Test Case 3: Discover Published service APIs by not registered API Invoker](#test-case-3-discover-published-service-apis-by-not-registered-api-invoker)
  - [Test Case 4: Discover Published service APIs by registered API Invoker with 1 result filtered](#test-case-4-discover-published-service-apis-by-registered-api-invoker-with-1-result-filtered)
  - [Test Case 5: Discover Published service APIs by registered API Invoker filtered with no match](#test-case-5-discover-published-service-apis-by-registered-api-invoker-filtered-with-no-match)
  - [Test Case 6: Discover Published service APIs by registered API Invoker not filtered](#test-case-6-discover-published-service-apis-by-registered-api-invoker-not-filtered)


# Test Plan for CAPIF Discover Service
At this documentation you will have all information and related files and examples of test plan for this API.

# Tests

## Test Case 1: Discover Published service APIs by Authorised API Invoker
* Test ID: ***capif_api_discover_service-1***
* Description:

  This test case will check if NetApp (Invoker) can discover published service APIs.
* Pre-Conditions:
  * Service APIs are published.
  * NetApp was registered previously
  * NetApp was onboarded previously with {onboardingId}
  
* Information of Test:
  1. Create public and private key at publisher

  2. Register of Publisher at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId
     * Get ccf_publish_url

  3. Publish Service API at CCF:
     * Send Post to ccf_publish_url *https://{CAPIF_HOSTNAME}/published-apis/v1/{apfId}/service-apis*
     * body [service api description] with apiName service_1
     * Get apiId

  4. Create public and private key at invoker

  5. Register of Invoker at CCF:
     * Send POST to http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register 
     * body [invoker register body]
     * get ccf_dicover_url

  6. Onboard Invoker:
     * Send POST to https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  7. Request Discover Published APIs:
     * Send GET to ccf_discover_url *https://{CAPIF_HOSTNAME}/service-apis/v1/allServiceAPIs?api-invoker-id={apiInvokerId}*
     * Param api-invoker-id is mandatory

* Execution Steps:
  
  1. Register Publisher and Publish Service API at CCF
  2. Register Invoker and Onboard Invoker at CCF
  3. Discover Service APIs by Invoker

* Expected Result:

  1. Response to Publish request must accomplish:
     1. **201 Created**
     2. Response Body must follow **ServiceAPIDescription** data structure with:
        * apiId
     3. Response Header **Location** must be received with URI to new resource created, following this structure: *{apiRoot}/published-apis/v1/{apfId}/service-apis/{serviceApiId}*

  2. Response to Onboard request must accomplish:
     1. **201 Created**
     2. Response Body must follow **APIInvokerEnrolmentDetails** data structure with:
        * apiInvokerId
        * onboardingInformation->apiInvokerCertificate must contain the public key signed.
     3. Response Header **Location** must be received with URI to new resource created, following this structure: *{apiRoot}/api-invoker-management/{apiVersion}/onboardedInvokers/{onboardingId}*
  3. Response to Discover Request By Invoker:
     1. **200 OK** response.
     2. Response body must follow **DiscoveredAPIs** data structure:
        * Check if DiscoveredAPIs contains the API Published previously


## Test Case 2: Discover Published service APIs by Non Authorised API Invoker
* Test ID: ***capif_api_discover_service-2***
* Description:

  This test case will check that an API Publisher can't discover published APIs because is not authorized.

* Pre-Conditions:
  * Service APIs are published.
  
* Information of Test:
  1. Create public and private key at publisher

  2. Register of Publisher at CCF:
     * Send POST to *http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register* 
     * body [publisher register body]
     * Get subscriberId
     * Get ccf_publish_url

  3. Publish Service API at CCF:
     * Send Post to ccf_publish_url *https://{CAPIF_HOSTNAME}/published-apis/v1/{apfId}/service-apis*
     * body [service api description] with apiName service_1
     * Get apiId

  4. Create public and private key at invoker

  5. Register of Invoker at CCF:
     * Send POST to http://{CAPIF_HOSTNAME}:{CAPIF_HTTP_PORT}/register 
     * body [invoker register body]
     * get ccf_dicover_url

  6. Onboard Invoker:
     * Send POST to https://{CAPIF_HOSTNAME}/api-invoker-management/v1/onboardedInvokers
     * Reference Request Body: [invoker onboarding body]
     * "onboardingInformation"->"apiInvokerPublicKey": must contain public key generated by Invoker.

  7. Request Discover Published APIs:
     * Send GET to ccf_discover_url *https://{CAPIF_HOSTNAME}/service-apis/v1/allServiceAPIs?api-invoker-id={apiInvokerId}*
     * Param api-invoker-id is mandatory
     * Using Publisher certificate

* Execution Steps:
  
  1. Register Publisher and Publish Service API at CCF
  2. Register Invoker and Onboard Invoker at CCF
  3. Discover Service APIs by Publisher

* Expected Result:

  1. Response to Publish request must accomplish:
     1. **201 Created**
     2. Response Body must follow **ServiceAPIDescription** data structure with:
        * apiId
     3. Response Header **Location** must be received with URI to new resource created, following this structure: *{apiRoot}/published-apis/v1/{apfId}/service-apis/{serviceApiId}*

  2. Response to Onboard request must accomplish:
     1. **201 Created**
     2. Response Body must follow **APIInvokerEnrolmentDetails** data structure with:
        * apiInvokerId
        * onboardingInformation->apiInvokerCertificate must contain the public key signed.
     3. Response Header **Location** must be received with URI to new resource created, following this structure: *{apiRoot}/api-invoker-management/{apiVersion}/onboardedInvokers/{onboardingId}*

  3. Response to Discover Request By Invoker:
     1. **401 Unauthorized**
     2. Error Response Body must accomplish with **ProblemDetails** data structure with:
        * status 401
        * title with message "Unauthorized"
        * detail with message "User not authorized".
        * cause with message "Certificate not authorized".


## Test Case 3: Discover Published service APIs by not registered API Invoker
  
  This test case will check that a not registered invoker is forbidden to discover published APIs  

* Pre-Conditions: 
  
  API service is previously registered at CAPIF core with api-invoker-id with 2 API services registered

* Actions:

  GET service filtered by name

* Post-Conditions:
  
  403 Forbidden

## Test Case 4: Discover Published service APIs by registered API Invoker with 1 result filtered
  
  This test case will check that a registered invoker search of one specific API through discover published APIs  

* Pre-Conditions: 
  
  API service is previously registered at CAPIF core with api-invoker-id with 2 API services registered

* Actions:

  GET service with api-name query parameter with one registered name

* Post-Conditions:
  
  200 Ok with 1 api returned

## Test Case 5: Discover Published service APIs by registered API Invoker filtered with no match
  
  This test case will check that a registered invoker search of not present API through discover published APIs  

* Pre-Conditions: 
  
  API service is previously registered at CAPIF core with api-invoker-id with 2 API services registered

* Actions:

  GET service with api-name query parameter with not registered name

* Post-Conditions:
  
  200 Ok with empty list returned

## Test Case 6: Discover Published service APIs by registered API Invoker not filtered
  
  This test case will check that a registered invoker search of not present API through discover published APIs  

* Pre-Conditions: 
  
  API service is previously registered at CAPIF core with api-invoker-id with 2 API services registered

* Actions:

  GET service without api-name query parameter

* Post-Conditions:
  
  200 Ok with 2 api returned


[service api description]: ./api_publish_service/service_api_description_post_example.json  "Service API Description Request"
[publisher register body]: ./api_publish_service/publisher_register_body.json  "Publish register Body"
[invoker onboarding body]: ../api_invoker_management/invoker_details_post_example.json  "API Invoker Request"
[invoker register body]: ../api_invoker_management/invoker_register_body.json  "Invoker Register Body"


[Return To All Test Plans]: ../README.md
